<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #title {
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 10px;
            text-align: center;
            color: #ffff00
        }
        body {
            overflow: hidden
        }
    </style>
</head>
<body>
<div id="title">Basic Online Game Demo<br><button id="login">login</button></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
<script>
    var camera, scene, renderer, stats, clock, raycaster, mouse = new THREE.Vector2(), socket;
    var r = 40.0, player = 0, omega = Math.PI * 2, turn = true;
    var pickables = [], allCar = [];

    window.addEventListener('resize', onWindowResize, false);
    document.addEventListener('mousedown',onDocumentMouseDown,false);



    $(function () {
        socket = io();
        console.log(socket);

        socket.on('toggle',function (msg) {

        });

        socket.on('init',function (msg) {
            player = parseInt(msg);
        });
    });

    $('#login').click(function (){
        socket.emit('init', 33);
    });

    class Car{
        constructor(){
            this.object = new THREE.Object3D();
            this.object.position.set((player - 1) * r * 2,0,0);
            this.car = buildVehicle();
            this.object.add(this.car);
            this.car.position.set(r,0,0);
            this.angle = 0;
            this.tuggle = true;

            this.plane = new THREE.Mesh(new THREE.CircleGeometry(r,32),new THREE.MeshBasicMaterial({
                transparent: true,
                opacity: 0.5,
                visible: true
            }));

        }

        update(dt){
            this.angle += dt * omega;
            this.car.position.copy(new THREE.Vector3(r,0,0).applyAxisAngle(new THREE.Vector3(0,0,1),this.angle));
        }
    }

    init();
    animate();

    function buildVehicle() {
        var car = new THREE.Object3D();
        var mat = new THREE.MeshNormalMaterial();
        var body = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 2, 20), mat);
        car.add(body);
        car.rotation.x = Math.PI / 2;
        return car;
    }

    function init() {
        scene = new THREE.Scene();
        clock = new THREE.Clock();
        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        stats.domElement.style.zIndex = 100;
        document.body.appendChild(stats.domElement);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(0,0,280);
        camera.lookAt(new THREE.Vector3());
        scene.add(camera);

        var gridXZ = new THREE.GridHelper(2000, 200, 'red', 'white');
        gridXZ.rotation.x = Math.PI / 2;
        scene.add(gridXZ);


        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x888888);

        raycaster = new THREE.Raycaster();
        document.body.appendChild(renderer.domElement);
        ////////////////////////////////////////////////////////////////////////


    }

    function animate() {
        stats.update();

        var dt = clock.getDelta();

        requestAnimationFrame(animate);
        render();
    }
    function render() {
        renderer.render(scene, camera);
    }
    function onDocumentMouseDown(event) {
        event.preventDefault();
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(pickables);
        if (intersects.length > 0) {
            turn = !turn;
            socket.emit('toggle',turn);
        }
    }

    function onWindowResize() {
        var width = window.innerWidth;
        var height = window.innerHeight;
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
    }
</script>
</body>
</html>